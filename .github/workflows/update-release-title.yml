name: Update Release Title

on:
  workflow_call:

jobs:
  update-title:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
    steps:
      - name: Download dist-manifest.json artifact
        uses: actions/download-artifact@v4
        with:
          name: artifacts-plan-dist-manifest
          path: .
      
      - name: Update announcement_title in dist-manifest.json
        run: |
          # Read the manifest
          if [ ! -f plan-dist-manifest.json ]; then
            echo "Error: plan-dist-manifest.json not found"
            exit 1
          fi
          
          # Extract current announcement_title and modify it
          # The format should be "DisFork v{VERSION}" instead of "{VERSION} (DATE)"
          jq '.announcement_title as $title |
              if $title then
                # Extract version from the title (removes date part if present)
                ($title | split(" ")[0]) as $version |
                # Validate that the version looks like a semantic version
                if ($version | test("^[0-9]+\\.[0-9]+\\.[0-9]+(-[a-zA-Z0-9-]+(\\.[a-zA-Z0-9-]+)*)?(\\+[a-zA-Z0-9-]+(\\.[a-zA-Z0-9-]+)*)?$")) then
                  .announcement_title = "DisFork v\($version)"
                else
                  # If version doesn't match expected format, log a warning but don't fail
                  . | . + {_warning: "Could not parse version from title: \($title)"}
                end
              else
                .
              end' plan-dist-manifest.json > plan-dist-manifest-updated.json
          
          # Replace the original file
          mv plan-dist-manifest-updated.json plan-dist-manifest.json
          
          # Show the change
          echo "Updated announcement_title:"
          jq -r '.announcement_title' plan-dist-manifest.json
          
          # Check for warnings
          if jq -e '._warning' plan-dist-manifest.json > /dev/null 2>&1; then
            echo "Warning: $(jq -r '._warning' plan-dist-manifest.json)"
            # Remove the warning field
            jq 'del(._warning)' plan-dist-manifest.json > plan-dist-manifest-clean.json
            mv plan-dist-manifest-clean.json plan-dist-manifest.json
          fi
      
      - name: Upload updated dist-manifest.json
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-plan-dist-manifest
          path: plan-dist-manifest.json
          overwrite: true
